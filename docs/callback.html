<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>IRCMiniChat Twitch Callback</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            background: #111;
            color: #eee;
            padding: 20px;
        }
        pre {
            background: #222;
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>IRCMiniChat – Callback</h1>
    <p>Se vedi questa pagina, la redirect da Twitch funziona ✅</p>
    <p>Parametri ricevuti:</p>
    <pre id="output">HTML OK (pre iniziale) — se resta così, JS non gira</pre>

<script>
  const out = document.getElementById('output');

  // 1) Query params (debug)
  const url = new URL(window.location.href);
  const queryParams = {};
  for (const [k, v] of url.searchParams.entries()) {
    queryParams[k] = v;
  }

  // 2) Fragment params (#access_token=...&scope=...&state=...)
  const hash = window.location.hash.startsWith('#')
    ? window.location.hash.substring(1)
    : window.location.hash;

  const fragmentParams = {};
  if (hash.length > 0) {
    const parts = hash.split('&');
    for (const p of parts) {
      const [k, v] = p.split('=');
      if (!k) continue;
      fragmentParams[k] = decodeURIComponent(v || '');
    }
  }

  // 3) Debug output
  out.textContent = JSON.stringify({ query: queryParams, fragment: fragmentParams }, null, 2);

  // 4) state + token
  const state = fragmentParams["state"] || "";
  const token = fragmentParams["access_token"] || "";
  if (!token) return;

  // 5) Deep link: scegli schema in base allo state
  // v4- -> twitchminichatv4
  // v3- -> ircminichatv3
  // v2- -> ircminichatv2
  // else -> ircminichat (v1 compat)
  let scheme = "ircminichat";
  if (state.startsWith("v4-")) scheme = "twitchminichatv4";
  else if (state.startsWith("v3-")) scheme = "ircminichatv3";
  else if (state.startsWith("v2-")) scheme = "ircminichatv2";

  // 6) Deep link standard
  let deeplink = `${scheme}://auth#access_token=${encodeURIComponent(token)}&state=${encodeURIComponent(state)}`;

  // Compat V1: se state è slot1-..., estrai slot e aggiungilo
  if (!state.startsWith("v2-") && !state.startsWith("v3-") && !state.startsWith("v4-") && state.startsWith("slot")) {
    let slot = "1";
    const match = state.match(/^slot(\d+)/);
    if (match && match[1]) slot = match[1];
    deeplink = `${scheme}://auth#slot=${encodeURIComponent(slot)}&access_token=${encodeURIComponent(token)}&state=${encodeURIComponent(state)}`;
  }

  setTimeout(() => {
    window.location = deeplink;
  }, 250);
</script>




</body>
</html>
